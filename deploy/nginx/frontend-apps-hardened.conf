# =============================================================================
# DotMac Frontend Applications - Hardened Nginx Configuration
# =============================================================================
# Production-ready configuration with:
#   - TLS 1.2+ only with modern ciphers
#   - HSTS with preload
#   - CSP per tier (platform vs ISP)
#   - Cookie isolation per subdomain
#   - Health check endpoints
# =============================================================================

# Include shared configurations
include /etc/nginx/conf.d/ssl.conf;
include /etc/nginx/conf.d/security-headers.conf;

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=100r/s;
limit_conn_zone $binary_remote_addr zone=conn:10m;

# Upstream definitions with health checks
upstream platform_admin {
    server platform-admin-app:3002 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream platform_reseller {
    server platform-reseller:3004 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream platform_tenant {
    server platform-tenant:3003 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream isp_ops {
    server isp-ops-app:3001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream isp_reseller {
    server isp-reseller:3005 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream isp_customer {
    server isp-customer:3006 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream backend_api {
    server backend:8000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# =============================================================================
# Platform Admin - admin.platform.dotmac.io
# Cookie domain: admin.platform.dotmac.io (strict, no sharing)
# =============================================================================
server {
    listen 443 ssl http2;
    server_name admin.platform.dotmac.io;

    ssl_certificate /etc/nginx/ssl/platform.dotmac.io.crt;
    ssl_certificate_key /etc/nginx/ssl/platform.dotmac.io.key;

    # Platform tier CSP
    add_header Content-Security-Policy $platform_csp always;

    # Connection limits
    limit_conn conn 50;

    # Health check endpoint (no auth required)
    location /api/health {
        proxy_pass http://platform_admin;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    # Login rate limiting
    location /api/platform/v1/auth/ {
        limit_req zone=login burst=10 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Cookie settings for platform admin
        proxy_cookie_domain ~\.(.+)$ admin.platform.dotmac.io;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";
    }

    # API proxy
    location /api/ {
        limit_req zone=api burst=50 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;

        proxy_cookie_domain ~\.(.+)$ admin.platform.dotmac.io;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";
    }

    # Frontend app
    location / {
        proxy_pass http://platform_admin;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Static assets caching
    location /_next/static/ {
        proxy_pass http://platform_admin;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}

# =============================================================================
# Platform Partners - partners.platform.dotmac.io
# Cookie domain: partners.platform.dotmac.io (strict, no sharing)
# =============================================================================
server {
    listen 443 ssl http2;
    server_name partners.platform.dotmac.io;

    ssl_certificate /etc/nginx/ssl/platform.dotmac.io.crt;
    ssl_certificate_key /etc/nginx/ssl/platform.dotmac.io.key;

    add_header Content-Security-Policy $platform_csp always;
    limit_conn conn 50;

    location /api/health {
        proxy_pass http://platform_reseller;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    location /api/platform/v1/auth/partner/ {
        limit_req zone=login burst=10 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cookie_domain ~\.(.+)$ partners.platform.dotmac.io;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";
    }

    location /api/ {
        limit_req zone=api burst=50 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cookie_domain ~\.(.+)$ partners.platform.dotmac.io;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";
    }

    location / {
        proxy_pass http://platform_reseller;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /_next/static/ {
        proxy_pass http://platform_reseller;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}

# =============================================================================
# Platform Tenant - my.platform.dotmac.io
# Cookie domain: my.platform.dotmac.io (strict, no sharing)
# =============================================================================
server {
    listen 443 ssl http2;
    server_name my.platform.dotmac.io;

    ssl_certificate /etc/nginx/ssl/platform.dotmac.io.crt;
    ssl_certificate_key /etc/nginx/ssl/platform.dotmac.io.key;

    add_header Content-Security-Policy $platform_csp always;
    limit_conn conn 50;

    location /api/health {
        proxy_pass http://platform_tenant;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    location /api/platform/v1/auth/tenant/ {
        limit_req zone=login burst=10 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cookie_domain ~\.(.+)$ my.platform.dotmac.io;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";
    }

    location /api/ {
        limit_req zone=api burst=50 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cookie_domain ~\.(.+)$ my.platform.dotmac.io;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";
    }

    location / {
        proxy_pass http://platform_tenant;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /_next/static/ {
        proxy_pass http://platform_tenant;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}

# =============================================================================
# ISP Admin - app.{tenant}.dotmac.io
# Cookie domain: app.{tenant}.dotmac.io (per-tenant isolation)
# =============================================================================
server {
    listen 443 ssl http2;
    server_name ~^app\.(?<tenant>[^.]+)\.dotmac\.io$;

    ssl_certificate /etc/nginx/ssl/wildcard.dotmac.io.crt;
    ssl_certificate_key /etc/nginx/ssl/wildcard.dotmac.io.key;

    # ISP tier CSP (allows payment widgets)
    add_header Content-Security-Policy $isp_csp always;
    limit_conn conn 100;

    # Set cookie domain dynamically per tenant
    set $cookie_domain "app.$tenant.dotmac.io";

    location /api/health {
        proxy_pass http://isp_ops;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    location /api/isp/v1/auth/ {
        limit_req zone=login burst=10 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Tenant-Slug $tenant;

        proxy_cookie_domain ~\.(.+)$ $cookie_domain;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";
    }

    location /api/ {
        limit_req zone=api burst=50 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Tenant-Slug $tenant;
        proxy_read_timeout 86400;

        proxy_cookie_domain ~\.(.+)$ $cookie_domain;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";
    }

    location / {
        proxy_pass http://isp_ops;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Tenant-Slug $tenant;
    }

    location /_next/static/ {
        proxy_pass http://isp_ops;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}

# =============================================================================
# ISP Reseller - agents.{tenant}.dotmac.io
# Cookie domain: agents.{tenant}.dotmac.io (per-tenant isolation)
# =============================================================================
server {
    listen 443 ssl http2;
    server_name ~^agents\.(?<tenant>[^.]+)\.dotmac\.io$;

    ssl_certificate /etc/nginx/ssl/wildcard.dotmac.io.crt;
    ssl_certificate_key /etc/nginx/ssl/wildcard.dotmac.io.key;

    add_header Content-Security-Policy $isp_csp always;
    limit_conn conn 100;

    set $cookie_domain "agents.$tenant.dotmac.io";

    location /api/health {
        proxy_pass http://isp_reseller;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    location /api/isp/v1/auth/reseller/ {
        limit_req zone=login burst=10 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Tenant-Slug $tenant;

        proxy_cookie_domain ~\.(.+)$ $cookie_domain;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";
    }

    location /api/ {
        limit_req zone=api burst=50 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Tenant-Slug $tenant;

        proxy_cookie_domain ~\.(.+)$ $cookie_domain;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";
    }

    location / {
        proxy_pass http://isp_reseller;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Tenant-Slug $tenant;
    }

    location /_next/static/ {
        proxy_pass http://isp_reseller;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}

# =============================================================================
# ISP Customer - my.{tenant}.dotmac.io
# Cookie domain: my.{tenant}.dotmac.io (per-tenant isolation)
# =============================================================================
server {
    listen 443 ssl http2;
    server_name ~^my\.(?<tenant>[^.]+)\.dotmac\.io$;

    ssl_certificate /etc/nginx/ssl/wildcard.dotmac.io.crt;
    ssl_certificate_key /etc/nginx/ssl/wildcard.dotmac.io.key;

    add_header Content-Security-Policy $isp_csp always;
    limit_conn conn 200;  # Higher for customer portal

    set $cookie_domain "my.$tenant.dotmac.io";

    location /api/health {
        proxy_pass http://isp_customer;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    location /api/isp/v1/auth/customer/ {
        limit_req zone=login burst=10 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Tenant-Slug $tenant;

        proxy_cookie_domain ~\.(.+)$ $cookie_domain;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Lax";  # Lax for customer (OAuth redirects)
    }

    location /api/ {
        limit_req zone=api burst=50 nodelay;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Tenant-Slug $tenant;

        proxy_cookie_domain ~\.(.+)$ $cookie_domain;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Lax";
    }

    location / {
        proxy_pass http://isp_customer;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Tenant-Slug $tenant;
    }

    location /_next/static/ {
        proxy_pass http://isp_customer;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}

# =============================================================================
# HTTP to HTTPS redirect (all hosts)
# =============================================================================
server {
    listen 80 default_server;
    server_name _;
    return 301 https://$host$request_uri;
}

# =============================================================================
# Default server (catch-all for invalid hosts)
# =============================================================================
server {
    listen 443 ssl http2 default_server;
    server_name _;

    ssl_certificate /etc/nginx/ssl/default.crt;
    ssl_certificate_key /etc/nginx/ssl/default.key;

    return 444;  # Close connection without response
}
