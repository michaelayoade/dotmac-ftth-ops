# =============================================================================
# DotMac Security Headers Configuration
# =============================================================================
# Security headers for frontend applications
# =============================================================================

# -----------------------------------------------------------------------------
# Platform Tier Security Headers
# More restrictive CSP for admin interfaces
# -----------------------------------------------------------------------------
map $host $platform_csp {
    default "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss: https:; frame-ancestors 'none'; base-uri 'self'; form-action 'self';";
}

# -----------------------------------------------------------------------------
# ISP Tier Security Headers
# Slightly relaxed for customer-facing apps (may embed payment widgets, etc.)
# -----------------------------------------------------------------------------
map $host $isp_csp {
    default "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://www.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss: https:; frame-src https://js.stripe.com https://www.google.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self';";
}

# -----------------------------------------------------------------------------
# Common Security Headers (apply to all apps)
# -----------------------------------------------------------------------------

# HSTS - Strict Transport Security (2 years, include subdomains, preload)
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# XSS Protection (legacy browsers)
add_header X-XSS-Protection "1; mode=block" always;

# Prevent clickjacking
add_header X-Frame-Options "SAMEORIGIN" always;

# Referrer Policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (formerly Feature-Policy)
add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(self), gyroscope=(), magnetometer=(), microphone=(), payment=(self), usb=()" always;

# Cross-Origin policies
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Embedder-Policy "require-corp" always;
add_header Cross-Origin-Resource-Policy "same-origin" always;
