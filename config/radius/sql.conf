# FreeRADIUS SQL Module Configuration
# PostgreSQL backend for RADIUS authentication and accounting

sql {
    dialect = "postgresql"
    driver = "rlm_sql_postgresql"

    # PostgreSQL connection
    server = "${RADIUS_DB_HOST}"
    port = ${RADIUS_DB_PORT}
    login = "${RADIUS_DB_USER}"
    password = "${RADIUS_DB_PASSWORD}"
    radius_db = "${RADIUS_DB_NAME}"

    # Connection pool
    pool {
        start = 5
        min = 4
        max = 32
        spare = 10
        uses = 0
        retry_delay = 30
        lifetime = 0
        idle_timeout = 60
    }

    # Read clients (NAS) from database
    read_clients = yes
    client_table = "nas"

    # Queries for authentication (radcheck)
    authorize_check_query = "\
        SELECT id, username, attribute, value, op \
        FROM ${radius_db}.radcheck \
        WHERE username = '%{SQL-User-Name}' \
        AND tenant_id = '%{Tenant-ID}' \
        ORDER BY id"

    authorize_reply_query = "\
        SELECT id, username, attribute, value, op \
        FROM ${radius_db}.radreply \
        WHERE username = '%{SQL-User-Name}' \
        AND tenant_id = '%{Tenant-ID}' \
        ORDER BY id"

    # Group membership queries
    authorize_group_check_query = "\
        SELECT id, groupname, attribute, Value, op \
        FROM ${radius_db}.radgroupcheck \
        WHERE groupname = '%{Sql-Group}' \
        AND tenant_id = '%{Tenant-ID}' \
        ORDER BY id"

    authorize_group_reply_query = "\
        SELECT id, groupname, attribute, value, op \
        FROM ${radius_db}.radgroupreply \
        WHERE groupname = '%{Sql-Group}' \
        AND tenant_id = '%{Tenant-ID}' \
        ORDER BY id"

    # Accounting queries
    accounting {
        reference = "%{tolower:type.%{Acct-Status-Type}.query}"

        type {
            accounting-on {
                query = "\
                    UPDATE ${radius_db}.radacct \
                    SET acctstoptime = NOW(), \
                        acctterminatecause = '%{Acct-Terminate-Cause}' \
                    WHERE acctstoptime IS NULL \
                    AND nasipaddress = '%{NAS-IP-Address}' \
                    AND tenant_id = '%{Tenant-ID}' \
                    AND acctstarttime <= NOW()"
            }

            accounting-off {
                query = "${....accounting-on.query}"
            }

            start {
                query = "\
                    INSERT INTO ${radius_db}.radacct \
                    (acctsessionid, acctuniqueid, username, realm, nasipaddress, \
                     nasportid, nasporttype, acctstarttime, acctupdatetime, \
                     acctsessiontime, acctauthentic, connectinfo_start, \
                     framedipaddress, framedprotocol, tenant_id, subscriber_id) \
                    VALUES \
                    ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', \
                     '%{SQL-User-Name}', '%{Realm}', '%{NAS-IP-Address}', \
                     '%{NAS-Port}', '%{NAS-Port-Type}', NOW(), NOW(), \
                     0, '%{Acct-Authentic}', '%{Connect-Info}', \
                     '%{Framed-IP-Address}', '%{Framed-Protocol}', \
                     '%{Tenant-ID}', '%{Subscriber-ID}')"
            }

            interim-update {
                query = "\
                    UPDATE ${radius_db}.radacct \
                    SET acctupdatetime = NOW(), \
                        acctinputoctets = '%{Acct-Input-Octets}', \
                        acctoutputoctets = '%{Acct-Output-Octets}', \
                        acctsessiontime = '%{Acct-Session-Time}' \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{SQL-User-Name}' \
                    AND nasipaddress = '%{NAS-IP-Address}' \
                    AND tenant_id = '%{Tenant-ID}'"
            }

            stop {
                query = "\
                    UPDATE ${radius_db}.radacct \
                    SET acctstoptime = NOW(), \
                        acctsessiontime = '%{Acct-Session-Time}', \
                        acctinputoctets = '%{Acct-Input-Octets}', \
                        acctoutputoctets = '%{Acct-Output-Octets}', \
                        acctterminatecause = '%{Acct-Terminate-Cause}' \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{SQL-User-Name}' \
                    AND nasipaddress = '%{NAS-IP-Address}' \
                    AND tenant_id = '%{Tenant-ID}'"
            }
        }
    }

    # Post-authentication logging
    post-auth {
        reference = ".query"
        query = "\
            INSERT INTO ${radius_db}.radpostauth \
            (username, pass, reply, authdate, tenant_id) \
            VALUES \
            ('%{User-Name}', '%{%{User-Password}:-%{Chap-Password}}', \
             '%{reply:Packet-Type}', NOW(), '%{Tenant-ID}')"
    }
}
