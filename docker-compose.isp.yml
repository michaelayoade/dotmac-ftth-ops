# ISP-Specific Infrastructure Services
# Deploy with: docker compose -f docker-compose.isp.yml up -d

services:
  # FreeRADIUS - AAA Server
  freeradius:
    image: freeradius-postgresql:latest
    container_name: isp-freeradius
    platform: linux/amd64
    environment:
      - RADIUS_DB_TYPE=postgresql
      - RADIUS_DB_HOST=postgres
      - RADIUS_DB_PORT=5432
      - RADIUS_DB_NAME=dotmac
      - RADIUS_DB_USER=dotmac_user
      - RADIUS_DB_PASSWORD=${POSTGRES_PASSWORD:-change-me-in-production}
    ports:
      - "1812:1812/udp"   # RADIUS Auth
      - "1813:1813/udp"   # RADIUS Accounting
      - "3799:3799/udp"   # CoA/DM (Change of Authorization / Disconnect Messages)
      - "18120:18120"     # Status server
    volumes:
      # Mount only custom clients file for now - defaults for everything else
      - ./config/radius/clients.conf:/etc/freeradius/clients.conf:ro
      - ./config/radius/dictionary:/etc/freeradius/dictionary.local:ro
      - ./config/radius/authorize:/etc/raddb/mods-config/files/authorize:ro
      - radius_logs:/var/log/freeradius
      - radius_config:/etc/freeradius
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      # NOTE: In production, healthcheck should use a real database user
      # For local dev, copy docker-compose.override.yml.example to enable test user
      test: ["CMD", "sh", "-c", "radiusd -v || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # NetBox - Network Inventory (IPAM/DCIM)
  netbox:
    image: netboxcommunity/netbox:latest
    container_name: isp-netbox
    environment:
      - DB_HOST=postgres
      - DB_NAME=netbox
      - DB_USER=dotmac_user
      - DB_PASSWORD=${POSTGRES_PASSWORD:-change-me-in-production}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SECRET_KEY=${NETBOX_SECRET_KEY:-changeme_secret_key_50chars_long_minimum}
      - SUPERUSER_NAME=${NETBOX_ADMIN_USER:-admin}
      - SUPERUSER_EMAIL=${NETBOX_ADMIN_EMAIL:-admin@example.com}
      - SUPERUSER_PASSWORD=${NETBOX_ADMIN_PASSWORD:-admin}
      - ALLOWED_HOSTS=*
      - SKIP_SUPERUSER=${NETBOX_SKIP_SUPERUSER:-false}
    ports:
      - "8080:8080"
    volumes:
      - netbox_media:/opt/netbox/netbox/media
      - netbox_reports:/opt/netbox/netbox/reports
      - netbox_scripts:/opt/netbox/netbox/scripts
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/status/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # NetBox Worker (for background tasks)
  netbox-worker:
    image: netboxcommunity/netbox:latest
    container_name: isp-netbox-worker
    entrypoint: /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py rqworker
    environment:
      - DB_HOST=postgres
      - DB_NAME=netbox
      - DB_USER=dotmac_user
      - DB_PASSWORD=${POSTGRES_PASSWORD:-change-me-in-production}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SECRET_KEY=${NETBOX_SECRET_KEY:-changeme_secret_key_50chars_long_minimum}
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MongoDB - for GenieACS
  mongodb:
    image: mongo:6
    container_name: isp-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-changeme_mongo_password}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # GenieACS - TR-069 ACS Server
  genieacs:
    image: drumsergio/genieacs:latest
    container_name: isp-genieacs
    environment:
      - GENIEACS_CWMP_ACCESS_LOG_FILE=/var/log/genieacs/cwmp-access.log
      - GENIEACS_NBI_ACCESS_LOG_FILE=/var/log/genieacs/nbi-access.log
      - GENIEACS_FS_ACCESS_LOG_FILE=/var/log/genieacs/fs-access.log
      - GENIEACS_UI_ACCESS_LOG_FILE=/var/log/genieacs/ui-access.log
      - GENIEACS_DEBUG_FILE=/var/log/genieacs/debug.yaml
      - GENIEACS_MONGODB_CONNECTION_URL=mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-changeme_mongo_password}@mongodb:27017/genieacs?authSource=admin
    ports:
      - "7547:7547"   # TR-069 CWMP
      - "7557:7557"   # NBI (REST API)
      - "7567:7567"   # Web UI
      - "7577:7577"   # File Server
    volumes:
      - genieacs_logs:/var/log/genieacs
      - genieacs_config:/opt/genieacs/config
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:7557/devices')\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # WireGuard VPN Gateway
  wireguard:
    image: linuxserver/wireguard:latest
    container_name: isp-wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - SERVERURL=${WG_SERVER_URL:-auto}
      - SERVERPORT=51820
      - PEERS=${WG_PEERS:-10}
      - PEERDNS=auto
      - INTERNAL_SUBNET=10.200.0.0/16
      - ALLOWEDIPS=0.0.0.0/0
      - LOG_CONFS=true
    ports:
      - "51820:51820/udp"
    volumes:
      - wireguard_config:/config
      - /lib/modules:/lib/modules:ro
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # LibreNMS - Network Monitoring
  librenms:
    image: librenms/librenms:latest
    container_name: isp-librenms
    hostname: librenms
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TZ=UTC
      - PUID=1000
      - PGID=1000
      - DB_HOST=postgres
      - DB_NAME=librenms
      - DB_USER=dotmac_user
      - DB_PASSWORD=${POSTGRES_PASSWORD:-change-me-in-production}
      - DB_TIMEOUT=60
      - LIBRENMS_SNMP_COMMUNITY=${LIBRENMS_SNMP_COMMUNITY:-public}
      - LIBRENMS_WEATHERMAP=false
      - LIBRENMS_WEATHERMAP_SCHEDULE=*/5 * * * *
    ports:
      - "8001:8000"  # Changed from 8000:8000 to free port 8000 for FastAPI E2E tests
    volumes:
      - librenms_data:/data
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # Ansible AWX Web (using AWX-EE image)
  awx-web:
    image: quay.io/ansible/awx:24.5.0
    container_name: isp-awx-web
    hostname: awxweb
    user: root
    command: /usr/bin/launch_awx_web.sh
    environment:
      - DATABASE_HOST=postgres
      - DATABASE_NAME=awx
      - DATABASE_USER=dotmac_user
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-change-me-in-production}
      - DATABASE_PORT=5432
      - AWX_ADMIN_USER=${AWX_ADMIN_USER:-admin}
      - AWX_ADMIN_PASSWORD=${AWX_ADMIN_PASSWORD:-changeme_awx_admin}
      - SECRET_KEY=${AWX_SECRET_KEY:-changeme_awx_secret_key_here}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8052:8052"
    volumes:
      - awx_projects:/var/lib/awx/projects
      - awx_rsyslog:/var/lib/awx/rsyslog
      - ./config/awx/settings.py:/etc/tower/settings.py:ro
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # AWX Task Manager
  awx-task:
    image: quay.io/ansible/awx:24.5.0
    container_name: isp-awx-task
    hostname: awx
    user: root
    command: /usr/bin/launch_awx_task.sh
    environment:
      - DATABASE_HOST=postgres
      - DATABASE_NAME=awx
      - DATABASE_USER=dotmac_user
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-change-me-in-production}
      - AWX_ADMIN_USER=${AWX_ADMIN_USER:-admin}
      - AWX_ADMIN_PASSWORD=${AWX_ADMIN_PASSWORD:-changeme_awx_admin}
      - SECRET_KEY=${AWX_SECRET_KEY:-changeme_awx_secret_key_here}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - awx_projects:/var/lib/awx/projects
      - awx_rsyslog:/var/lib/awx/rsyslog
      - ./config/awx/settings.py:/etc/tower/settings.py:ro
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # TimescaleDB - Time-Series Metrics Database
  timescaledb:
    image: timescale/timescaledb:latest-pg14
    container_name: isp-timescaledb
    environment:
      POSTGRES_USER: timescale_user
      POSTGRES_PASSWORD: ${TIMESCALE_PASSWORD:-changeme_timescale_password}
      POSTGRES_DB: metrics
    ports:
      - "5433:5432"
    volumes:
      - timescale_data:/var/lib/postgresql/data
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U timescale_user -d metrics"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Monitoring Stack
  # Node Exporter - System metrics
  node-exporter:
    image: prom/node-exporter:latest
    container_name: isp-node-exporter
    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host:ro
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - monitoring

  # cAdvisor - Container metrics
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: isp-cadvisor
    privileged: true
    devices:
      - /dev/kmsg
    ports:
      - "8082:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker:/var/lib/docker:ro
      - /dev/disk:/dev/disk:ro
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - monitoring

  # PostgreSQL Exporter - Database metrics
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: isp-postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER:-dotmac_user}:${POSTGRES_PASSWORD:-change-me-in-production}@postgres:5432/dotmac?sslmode=disable"
    ports:
      - "9187:9187"
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - monitoring

  # Redis Exporter - Cache metrics
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: isp-redis-exporter
    environment:
      REDIS_ADDR: "redis:6379"
    ports:
      - "9121:9121"
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - monitoring

  # Alertmanager - Alert routing and management
  alertmanager:
    image: prom/alertmanager:latest
    container_name: isp-alertmanager
    environment:
      ALERTMANAGER_WEBHOOK_SECRET: ${ALERTMANAGER_WEBHOOK_SECRET:-}
      ALERTMANAGER_WEBHOOK_URL: ${ALERTMANAGER_WEBHOOK_URL:-http://app:8000/api/v1/monitoring/alerts/webhook}
    entrypoint: ["/bin/sh", "/entrypoint/alertmanager-entrypoint.sh"]
    command:
      - '--storage.path=/alertmanager'
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/prometheus/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - ./monitoring/prometheus/alertmanager-entrypoint.sh:/entrypoint/alertmanager-entrypoint.sh:ro
      - alertmanager_data:/alertmanager
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - monitoring

  # Prometheus - Metrics collection and storage
  prometheus:
    image: prom/prometheus:latest
    container_name: isp-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alerts.yml:/etc/prometheus/alerts/alerts.yml:ro
      - prometheus_data:/prometheus
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - monitoring

  # Grafana - Metrics visualization
  grafana:
    image: grafana/grafana:latest
    container_name: isp-grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-changeme_grafana_admin}
      GF_INSTALL_PLUGINS: ${GRAFANA_PLUGINS:-}
    ports:
      - "3400:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - dotmac-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - monitoring

volumes:
  radius_logs:
    driver: local
  radius_config:
    driver: local
  netbox_media:
    driver: local
  netbox_reports:
    driver: local
  netbox_scripts:
    driver: local
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  genieacs_logs:
    driver: local
  genieacs_config:
    driver: local
  wireguard_config:
    driver: local
  librenms_data:
    driver: local
  awx_projects:
    driver: local
  awx_rsyslog:
    driver: local
  timescale_data:
    driver: local
  alertmanager_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  dotmac-network:
    external: true
    name: ${COMPOSE_PROJECT_NAME:-dotmac}-network
