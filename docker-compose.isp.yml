services:
  isp-backend:
    build:
      context: .
      dockerfile: ${ISP_BACKEND_DOCKERFILE:-Dockerfile}
    command: ${ISP_BACKEND_COMMAND:-uvicorn dotmac.platform.main:app --host 0.0.0.0 --port 8000}
    restart: unless-stopped
    environment:
      ENVIRONMENT: ${ISP_ENVIRONMENT:-development}
      LOG_LEVEL: ${ISP_LOG_LEVEL:-debug}
      DATABASE__HOST: ${ISP_DATABASE__HOST:-dotmac-postgres}
      DATABASE__PORT: ${ISP_DATABASE__PORT:-5432}
      DATABASE__DATABASE: ${ISP_DATABASE__DATABASE:-dotmac}
      DATABASE__USERNAME: ${ISP_DATABASE__USERNAME:-dotmac_user}
      DATABASE__PASSWORD: ${ISP_DATABASE__PASSWORD:-change-me}
      REDIS__HOST: ${ISP_REDIS__HOST:-dotmac-redis}
      REDIS__PORT: ${ISP_REDIS__PORT:-6379}
      REDIS__DB: ${ISP_REDIS__DB:-0}
      STORAGE__ENDPOINT: ${ISP_STORAGE__ENDPOINT:-http://dotmac-minio:9000}
      STORAGE__ACCESS_KEY: ${ISP_STORAGE__ACCESS_KEY:-minioadmin}
      STORAGE__SECRET_KEY: ${ISP_STORAGE__SECRET_KEY:-minioadmin123}
      STORAGE__BUCKET: ${ISP_STORAGE__BUCKET:-dotmac}
      STORAGE__USE_SSL: ${ISP_STORAGE__USE_SSL:-false}
      VAULT__ENABLED: ${ISP_VAULT__ENABLED:-false}
      VAULT__URL: ${ISP_VAULT__URL:-http://dotmac-vault:8200}
      VAULT__TOKEN: ${ISP_VAULT__TOKEN:-dev-token-12345}
      SECRET_KEY: ${ISP_SECRET_KEY:-dev-secret-change-me}
      AUTH__JWT_SECRET_KEY: ${ISP_AUTH__JWT_SECRET_KEY:-dev-jwt-secret-change-me}
      CELERY__BROKER_URL: ${ISP_CELERY__BROKER_URL:-redis://dotmac-redis:6379/2}
      CELERY__RESULT_BACKEND: ${ISP_CELERY__RESULT_BACKEND:-redis://dotmac-redis:6379/3}
      REQUIRE_REDIS_SESSIONS: ${ISP_REQUIRE_REDIS_SESSIONS:-false}
    ports:
      - "${ISP_BACKEND_PORT:-8000}:8000"
    volumes:
      - isp_storage:/var/lib/dotmac
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    extra_hosts:
      - "host.docker.internal:host-gateway"

  isp-frontend:
    build:
      context: ./frontend
      dockerfile: apps/isp-ops-app/Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: ${ISP_FRONTEND_NODE_ENV:-production}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://isp-backend:8000}
    ports:
      - "${ISP_FRONTEND_PORT:-3001}:3000"
    depends_on:
      - isp-backend

volumes:
  isp_storage:

networks:
  default:
    name: dotmac-network
    external: true
