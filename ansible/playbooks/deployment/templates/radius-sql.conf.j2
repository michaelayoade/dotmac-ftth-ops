# SQL Module Configuration for Tenant {{ tenant_id }}
# Generated by Ansible

sql sql-tenant-{{ tenant_id }} {
    driver = "rlm_sql_postgresql"
    dialect = "postgresql"

    # Connection info
    server = "{{ db_host }}"
    port = {{ db_port | default('5432') }}
    login = "tenant_{{ tenant_id }}_user"
    password = "{{ db_password }}"
    radius_db = "tenant_{{ tenant_id }}"

    # Connection pool
    pool {
        start = {{ resources.radius_sql_pool_start | default('5') }}
        min = {{ resources.radius_sql_pool_min | default('5') }}
        max = {{ resources.radius_sql_pool_max | default('32') }}
        spare = {{ resources.radius_sql_pool_spare | default('10') }}
        uses = {{ resources.radius_sql_pool_uses | default('0') }}
        retry_delay = 30
        lifetime = 0
        idle_timeout = 60
    }

    # Read clients from SQL
    read_clients = yes

    # Table configuration
    client_table = "radius_nas"

    # Radius attribute tables
    authorize_check_query = "SELECT id, username, attribute, op, value FROM radius_check WHERE username = '%{SQL-User-Name}' ORDER BY id"
    authorize_reply_query = "SELECT id, username, attribute, op, value FROM radius_reply WHERE username = '%{SQL-User-Name}' ORDER BY id"
    authorize_group_check_query = "SELECT id, groupname, attribute, op, value FROM radius_groupcheck WHERE groupname = '%{SQL-Group}' ORDER BY id"
    authorize_group_reply_query = "SELECT id, groupname, attribute, op, value FROM radius_groupreply WHERE groupname = '%{SQL-Group}' ORDER BY id"

    # Accounting queries
    accounting {
        reference = "%{tolower:type.%{Acct-Status-Type}.query}"

        type {
            accounting-on {
                query = "UPDATE radius_accounting SET acctstoptime = NOW(), acctterminatecause = '%{Acct-Terminate-Cause}' WHERE acctstoptime IS NULL AND nasipaddress = '%{NAS-IP-Address}'"
            }

            accounting-off {
                query = "UPDATE radius_accounting SET acctstoptime = NOW(), acctterminatecause = '%{Acct-Terminate-Cause}' WHERE acctstoptime IS NULL AND nasipaddress = '%{NAS-IP-Address}'"
            }

            start {
                query = "INSERT INTO radius_accounting (acctsessionid, acctuniqueid, username, realm, nasipaddress, nasportid, nasporttype, acctstarttime, acctupdatetime, acctstoptime, acctsessiontime, acctauthentic, connectinfo_start, connectinfo_stop, acctinputoctets, acctoutputoctets, calledstationid, callingstationid, acctterminatecause, servicetype, framedprotocol, framedipaddress) VALUES ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', '%{Realm}', '%{NAS-IP-Address}', '%{NAS-Port}', '%{NAS-Port-Type}', NOW(), NOW(), NULL, 0, '%{Acct-Authentic}', '%{Connect-Info}', NULL, 0, 0, '%{Called-Station-Id}', '%{Calling-Station-Id}', NULL, '%{Service-Type}', '%{Framed-Protocol}', '%{Framed-IP-Address}')"
            }

            interim-update {
                query = "UPDATE radius_accounting SET acctupdatetime = NOW(), acctsessiontime = '%{Acct-Session-Time}', acctinputoctets = '%{Acct-Input-Octets}', acctoutputoctets = '%{Acct-Output-Octets}' WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{SQL-User-Name}' AND nasipaddress = '%{NAS-IP-Address}'"
            }

            stop {
                query = "UPDATE radius_accounting SET acctstoptime = NOW(), acctsessiontime = '%{Acct-Session-Time}', acctinputoctets = '%{Acct-Input-Octets}', acctoutputoctets = '%{Acct-Output-Octets}', acctterminatecause = '%{Acct-Terminate-Cause}', connectinfo_stop = '%{Connect-Info}' WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{SQL-User-Name}' AND nasipaddress = '%{NAS-IP-Address}'"
            }
        }
    }

    # Post-authentication logging
    post-auth {
        reference = ".query"
        query = "INSERT INTO radius_postauth (username, pass, reply, authdate) VALUES ('%{User-Name}', '%{%{User-Password}:-Chap-Password}', '%{reply:Packet-Type}', NOW())"
    }
}
