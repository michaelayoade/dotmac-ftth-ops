# FreeRADIUS Configuration for Tenant {{ tenant_id }}
# Generated by Ansible

# Server identification
name = radiusd-tenant-{{ tenant_id }}
prefix = /usr
exec_prefix = /usr
sysconfdir = /etc
localstatedir = /var
sbindir = ${exec_prefix}/sbin
logdir = {{ radius_log_dir | default(data_dir + '/radius/logs') }}
raddbdir = /etc/freeradius/3.0
radacctdir = {{ radius_radacct_dir | default(data_dir + '/radius/radacct') }}

# Process configuration
pidfile = /var/run/freeradius/radiusd-tenant-{{ tenant_id }}.pid
user = freerad
group = freerad
max_request_time = 30
cleanup_delay = 5
max_requests = {{ resources.radius_max_requests | default('16384') }}

# Logging
log {
    destination = files
    colourise = yes
    file = ${logdir}/radius-tenant-{{ tenant_id }}.log
    syslog_facility = daemon
    stripped_names = no
    auth = yes
    auth_badpass = yes
    auth_goodpass = no
    msg_denied = "You are already logged in - access denied"
}

# Security
security {
    max_attributes = 200
    reject_delay = 1
    status_server = yes
}

# Thread pool
thread pool {
    start_servers = {{ resources.radius_start_servers | default('5') }}
    max_servers = {{ resources.radius_max_servers | default('32') }}
    min_spare_servers = {{ resources.radius_min_spare_servers | default('3') }}
    max_spare_servers = {{ resources.radius_max_spare_servers | default('10') }}
    max_requests_per_server = {{ resources.radius_max_requests_per_server | default('0') }}
    auto_limit_acct = no
}

# Modules
{% set sql_module_name = radius_sql_module_name | default('sql-tenant-' + tenant_id) %}
modules {
    $INCLUDE mods-enabled/{{ sql_module_name }}
}

# Instantiate
instantiate {
    {{ sql_module_name }}
}

# Listen on tenant-specific port
listen {
    type = auth
    ipaddr = *
    port = {{ radius_port }}
    limit {
        max_connections = {{ resources.radius_max_connections | default('256') }}
        lifetime = 0
        idle_timeout = 30
    }
}

listen {
    type = acct
    ipaddr = *
    port = {{ radius_acct_port | default(radius_port | int + 1) }}
    limit {
        max_connections = {{ resources.radius_max_connections | default('256') }}
        lifetime = 0
        idle_timeout = 30
    }
}

# CoA/DM port
listen {
    type = coa
    ipaddr = *
    port = {{ radius_coa_port }}
}

# Clients
$INCLUDE clients-tenant-{{ tenant_id }}.conf

# Virtual server
$INCLUDE sites-enabled/tenant-{{ tenant_id }}
