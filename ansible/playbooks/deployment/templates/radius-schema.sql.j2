-- RADIUS Database Schema for Tenant {{ tenant_id }}
-- Generated by Ansible
-- Compatible with FreeRADIUS 3.x and PostgreSQL

-- NAS (Network Access Server) table
CREATE TABLE IF NOT EXISTS radius_nas (
    id SERIAL PRIMARY KEY,
    nasname VARCHAR(128) NOT NULL UNIQUE,
    shortname VARCHAR(32),
    type VARCHAR(30) DEFAULT 'other',
    ports INTEGER,
    secret VARCHAR(60) NOT NULL,
    server VARCHAR(64),
    community VARCHAR(50),
    description VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- User check attributes (authentication)
CREATE TABLE IF NOT EXISTS radius_check (
    id SERIAL PRIMARY KEY,
    username VARCHAR(64) NOT NULL,
    attribute VARCHAR(64) NOT NULL,
    op VARCHAR(2) NOT NULL DEFAULT '==',
    value VARCHAR(253) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS radius_check_username_idx ON radius_check(username);

-- User reply attributes (authorization)
CREATE TABLE IF NOT EXISTS radius_reply (
    id SERIAL PRIMARY KEY,
    username VARCHAR(64) NOT NULL,
    attribute VARCHAR(64) NOT NULL,
    op VARCHAR(2) NOT NULL DEFAULT '=',
    value VARCHAR(253) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS radius_reply_username_idx ON radius_reply(username);

-- Group check attributes
CREATE TABLE IF NOT EXISTS radius_groupcheck (
    id SERIAL PRIMARY KEY,
    groupname VARCHAR(64) NOT NULL,
    attribute VARCHAR(64) NOT NULL,
    op VARCHAR(2) NOT NULL DEFAULT '==',
    value VARCHAR(253) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS radius_groupcheck_groupname_idx ON radius_groupcheck(groupname);

-- Group reply attributes
CREATE TABLE IF NOT EXISTS radius_groupreply (
    id SERIAL PRIMARY KEY,
    groupname VARCHAR(64) NOT NULL,
    attribute VARCHAR(64) NOT NULL,
    op VARCHAR(2) NOT NULL DEFAULT '=',
    value VARCHAR(253) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS radius_groupreply_groupname_idx ON radius_groupreply(groupname);

-- User to group mapping
CREATE TABLE IF NOT EXISTS radius_usergroup (
    id SERIAL PRIMARY KEY,
    username VARCHAR(64) NOT NULL,
    groupname VARCHAR(64) NOT NULL,
    priority INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(username, groupname)
);
CREATE INDEX IF NOT EXISTS radius_usergroup_username_idx ON radius_usergroup(username);

-- Accounting sessions
CREATE TABLE IF NOT EXISTS radius_accounting (
    radacctid BIGSERIAL PRIMARY KEY,
    acctsessionid VARCHAR(64) NOT NULL,
    acctuniqueid VARCHAR(32) NOT NULL UNIQUE,
    username VARCHAR(64),
    realm VARCHAR(64),
    nasipaddress INET NOT NULL,
    nasportid VARCHAR(32),
    nasporttype VARCHAR(32),
    acctstarttime TIMESTAMP,
    acctupdatetime TIMESTAMP,
    acctstoptime TIMESTAMP,
    acctinterval INTEGER,
    acctsessiontime BIGINT,
    acctauthentic VARCHAR(32),
    connectinfo_start VARCHAR(128),
    connectinfo_stop VARCHAR(128),
    acctinputoctets BIGINT,
    acctoutputoctets BIGINT,
    calledstationid VARCHAR(50),
    callingstationid VARCHAR(50),
    acctterminatecause VARCHAR(32),
    servicetype VARCHAR(32),
    framedprotocol VARCHAR(32),
    framedipaddress INET,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS radius_accounting_username_idx ON radius_accounting(username);
CREATE INDEX IF NOT EXISTS radius_accounting_session_idx ON radius_accounting(acctsessionid);
CREATE INDEX IF NOT EXISTS radius_accounting_nas_idx ON radius_accounting(nasipaddress);
CREATE INDEX IF NOT EXISTS radius_accounting_start_idx ON radius_accounting(acctstarttime);
CREATE INDEX IF NOT EXISTS radius_accounting_stop_idx ON radius_accounting(acctstoptime);

-- Post-authentication logging
CREATE TABLE IF NOT EXISTS radius_postauth (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(64) NOT NULL,
    pass VARCHAR(64),
    reply VARCHAR(32),
    authdate TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS radius_postauth_username_idx ON radius_postauth(username);
CREATE INDEX IF NOT EXISTS radius_postauth_date_idx ON radius_postauth(authdate);

-- Trigger to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_radius_nas_updated_at BEFORE UPDATE ON radius_nas
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Grant permissions to tenant user
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "tenant_{{ tenant_id }}_user";
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO "tenant_{{ tenant_id }}_user";
