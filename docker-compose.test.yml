# Docker Compose Configuration for Integration Tests
#
# This extends docker-compose.base.yml with test-specific settings.
# Services are optimized for fast startup and test isolation.
#
# Usage:
#   Integration tests automatically start services when using `-m integration`
#   Or manually: docker compose -f docker-compose.base.yml -f docker-compose.test.yml up -d

services:
  postgres:
    environment:
      POSTGRES_DB: dotmac_test
      POSTGRES_USER: dotmac_user
      POSTGRES_PASSWORD: change-me
    # Use tmpfs for faster test database (data not persisted)
    tmpfs:
      - /var/lib/postgresql/data
    # Disable fsync for faster writes in tests (data integrity not critical)
    command: >
      postgres
      -c fsync=off
      -c synchronous_commit=off
      -c full_page_writes=off
      -c random_page_cost=1.0
      -c effective_cache_size=512MB
      -c shared_buffers=256MB
      -c work_mem=16MB

  redis:
    # Use tmpfs for faster test cache
    tmpfs:
      - /data
    # Disable persistence for tests
    command: redis-server --save "" --appendonly no

  minio:
    # Use tmpfs for faster test storage
    tmpfs:
      - /data
    # Disable healthcheck interval for tests (starts faster)
    healthcheck:
      interval: 5s
      timeout: 2s
      retries: 3

  # Optional: Add other test-specific services here
  # netbox:
  #   image: netboxcommunity/netbox:latest
  #   environment:
  #     SKIP_SUPERUSER: "true"
  #     SKIP_STARTUP_SCRIPTS: "true"
  #   tmpfs:
  #     - /opt/netbox/netbox/media

  # freeradius:
  #   image: freeradius/freeradius-server:latest
  #   ports:
  #     - "1812:1812/udp"
  #     - "1813:1813/udp"
