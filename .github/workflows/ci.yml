# Consolidated CI Pipeline
#
# This single workflow handles all PR and push quality checks with a 5-layer approach:
# 1. Fast Gates - Lint, type check, unit tests (parallel, fail fast)
# 2. Contract Checks - TypeScript, MyPy, migrations, codegen
# 3. Build/Packaging - Frontend build, backend import smoke, docker validation
# 4. Integration/Smoke - Quick integration tests with real services
# 5. Infrastructure Hygiene - Security scans, dependency audits
#
# Design principles:
# - Fast fail: Layer 1 runs in parallel, blocks everything else
# - Cached: pnpm and Poetry deps cached for speed
# - Deterministic: proper service health checks, no flaky timeouts
# - Single workflow: one "CI" check on PRs instead of multiple

name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================================================
  # LAYER 1: FAST GATES (parallel, ~5 min)
  # These run first and in parallel. If any fail, later layers are skipped.
  # ============================================================================

  frontend-lint:
    name: "1. Frontend Lint"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        working-directory: frontend
        run: pnpm lint

  frontend-unit-tests:
    name: "1. Frontend Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        working-directory: frontend
        run: pnpm test --filter @dotmac/platform-admin-app --filter @dotmac/isp-ops-app
        continue-on-error: true  # Some apps may not have tests yet

  backend-lint:
    name: "1. Backend Lint"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Run Ruff check
        run: poetry run ruff check src/

      - name: Run Ruff format check
        run: poetry run ruff format --check src/

  backend-unit-tests:
    name: "1. Backend Unit Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Run unit tests
        env:
          PYTHONPATH: "${{ github.workspace }}/src"
          DOTMAC_AUTOSTART_SERVICES: "0"
        run: |
          poetry run pytest tests/ -m unit \
            --tb=short \
            -n auto \
            -q \
            --maxfail=10

  backend-integration-tests:
    name: "1. Backend Integration Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: dotmac_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: dotmac_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Wait for services
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 60 bash -c 'until nc -z localhost 5432; do sleep 1; done'
          echo "PostgreSQL is ready"
          echo "Waiting for Redis..."
          timeout 60 bash -c 'until nc -z localhost 6379; do sleep 1; done'
          echo "Redis is ready"

      - name: Run integration tests
        env:
          PYTHONPATH: "${{ github.workspace }}/src"
          DATABASE_URL: postgresql://dotmac_user:test_password@localhost:5432/dotmac_test
          DOTMAC_REDIS_URL: redis://localhost:6379/0
          DOTMAC_AUTOSTART_SERVICES: "0"
        run: |
          poetry run pytest tests/ -m integration \
            --tb=short \
            -n auto \
            -q \
            --maxfail=10

  backend-e2e-tests:
    name: "1. Backend E2E Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: dotmac_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: dotmac_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Wait for services
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 60 bash -c 'until nc -z localhost 5432; do sleep 1; done'
          echo "PostgreSQL is ready"
          echo "Waiting for Redis..."
          timeout 60 bash -c 'until nc -z localhost 6379; do sleep 1; done'
          echo "Redis is ready"

      - name: Run E2E tests
        env:
          PYTHONPATH: "${{ github.workspace }}/src"
          DATABASE_URL: postgresql://dotmac_user:test_password@localhost:5432/dotmac_test
          DOTMAC_REDIS_URL: redis://localhost:6379/0
          DOTMAC_AUTOSTART_SERVICES: "0"
        run: |
          poetry run pytest tests/ -m e2e \
            --tb=short \
            -n auto \
            -q \
            --maxfail=10
        continue-on-error: true  # E2E tests may not exist yet

  # ============================================================================
  # LAYER 2: CONTRACT CHECKS (~10 min)
  # Type checking, migrations, codegen - ensures contracts are valid
  # ============================================================================

  frontend-typecheck:
    name: "2. Frontend Types"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [frontend-lint]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: TypeScript type check
        working-directory: frontend
        run: pnpm type-check

  backend-typecheck:
    name: "2. Backend Types (MyPy)"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [backend-lint]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Run MyPy
        run: poetry run mypy src/

  backend-typecheck-strict:
    name: "2. Backend Types (Strict)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [backend-lint]

    strategy:
      fail-fast: false
      matrix:
        module:
          - path: "src/dotmac/platform/auth/"
            name: "Auth"
          - path: "src/dotmac/platform/secrets/"
            name: "Secrets"
          - path: "src/dotmac/platform/services/"
            name: "Services"
          - path: "src/dotmac/platform/subscribers/"
            name: "Subscribers"
          - path: "src/dotmac/platform/radius/"
            name: "RADIUS"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: MyPy Strict - ${{ matrix.module.name }}
        run: poetry run mypy --strict ${{ matrix.module.path }}

  migrations-check:
    name: "2. Migrations"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [backend-lint]

    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: dotmac
          POSTGRES_PASSWORD: dotmac
          POSTGRES_DB: dotmac_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Check for multiple migration heads
        run: |
          HEAD_COUNT=$(poetry run alembic heads 2>/dev/null | wc -l)
          if [ $HEAD_COUNT -gt 1 ]; then
            echo "::error::Multiple migration heads detected!"
            poetry run alembic heads
            exit 1
          fi
          echo "✅ Single migration head confirmed"

      - name: Test migrations up
        env:
          DATABASE_URL: postgresql://dotmac:dotmac@localhost:5432/dotmac_test
        run: |
          poetry run alembic upgrade head
          echo "✅ All migrations applied successfully"

      - name: Test migrations down
        env:
          DATABASE_URL: postgresql://dotmac:dotmac@localhost:5432/dotmac_test
        run: |
          poetry run alembic downgrade base
          echo "✅ All migrations rolled back successfully"

  test-quality:
    name: "2. Test Quality"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [backend-lint]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Check test pyramid markers
        run: |
          python3 scripts/test_pyramid_progress.py
          UNMARKED=$(python3 scripts/test_pyramid_progress.py --json | python3 -c "import json,sys; data=json.load(sys.stdin); print(sum(m['stats']['unmarked_files'] for m in data.values()))")
          if [ "$UNMARKED" != "0" ]; then
            echo "::warning::Found $UNMARKED unmarked test files"
          fi

      - name: Track mock usage
        run: bash scripts/count_mocks.sh
        continue-on-error: true

  # ============================================================================
  # LAYER 3: BUILD/PACKAGING (~15 min)
  # Verify everything compiles and packages correctly
  # ============================================================================

  frontend-build:
    name: "3. Frontend Build"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [frontend-typecheck, frontend-unit-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Build ISP Ops App
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
          BETTER_AUTH_BYPASS: "true"
        run: pnpm --filter @dotmac/isp-ops-app build

      - name: Build Platform Admin App
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
          BETTER_AUTH_BYPASS: "true"
        run: pnpm --filter @dotmac/platform-admin-app build
        continue-on-error: true

  backend-import-smoke:
    name: "3. Backend Import"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [backend-typecheck, backend-unit-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Compile all Python files
        run: |
          find src -name "*.py" -exec poetry run python -m py_compile {} +
          echo "✅ All Python files compile"

      - name: Import smoke test
        env:
          PYTHONPATH: "${{ github.workspace }}/src"
        run: |
          poetry run python -c "
          from dotmac.platform.main import app
          from dotmac.platform.routers import app as routers_app
          from dotmac.platform.core import ensure_pydantic_v2
          ensure_pydantic_v2()
          print('✅ All critical imports successful')
          "

  docker-validate:
    name: "3. Docker Validate"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [backend-lint, frontend-lint]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create minimal .env
        run: |
          cat > .env <<EOF
          POSTGRES_PASSWORD=test
          REDIS_PASSWORD=test
          RADIUS_SECRET=test
          SECRET_KEY=test_secret_key_32_characters_min
          JWT_SECRET_KEY=test_jwt_key_32_characters_minimum
          EOF

      - name: Validate docker-compose files
        run: |
          for f in docker-compose*.yml; do
            if [ -f "$f" ]; then
              docker compose -f "$f" config > /dev/null && echo "✅ $f" || echo "⚠️ $f has issues"
            fi
          done

  # ============================================================================
  # LAYER 5: INFRASTRUCTURE HYGIENE (~10 min)
  # Security scans and dependency audits
  # ============================================================================

  security-audit:
    name: "5. Security Audit"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [backend-lint, frontend-lint]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install --with dev --no-interaction

      - name: Bandit security scan
        run: poetry run bandit -r src/ -ll -q
        continue-on-error: true

      - name: Python dependency audit
        run: poetry run pip-audit --desc 2>&1 || echo "⚠️ Vulnerabilities found"
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Frontend audit
        working-directory: frontend
        run: |
          pnpm install --frozen-lockfile
          pnpm audit --audit-level=high || echo "⚠️ Audit warnings"
        continue-on-error: true

  # ============================================================================
  # SUMMARY
  # ============================================================================

  ci-success:
    name: "CI Success"
    runs-on: ubuntu-latest
    needs:
      - frontend-build
      - backend-unit-tests
      - backend-integration-tests
      - backend-e2e-tests
      - security-audit
      - docker-validate
    if: always()

    steps:
      - name: Check all critical jobs
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Layer | Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Frontend Lint | ${{ needs.frontend-lint.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Frontend Tests | ${{ needs.frontend-unit-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Backend Lint | ${{ needs.backend-lint.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Backend Unit Tests | ${{ needs.backend-unit-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Backend Integration Tests | ${{ needs.backend-integration-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Backend E2E Tests | ${{ needs.backend-e2e-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Frontend Types | ${{ needs.frontend-typecheck.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Backend Types | ${{ needs.backend-typecheck.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Migrations | ${{ needs.migrations-check.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Frontend Build | ${{ needs.frontend-build.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Backend Import | ${{ needs.backend-import-smoke.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Docker Validate | ${{ needs.docker-validate.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | Security | ${{ needs.security-audit.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical jobs failed
        if: |
          needs.frontend-build.result == 'failure' ||
          needs.backend-unit-tests.result == 'failure' ||
          needs.backend-integration-tests.result == 'failure'
        run: |
          echo "::error::Critical CI jobs failed"
          exit 1
