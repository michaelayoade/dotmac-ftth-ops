name: Docker Compose Pre-Flight Check

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'docker-compose*.yml'
      - 'config/**'
      - 'database/**'
      - 'monitoring/**'
      - 'scripts/docker-compose-pre-flight.sh'
      - '.github/workflows/docker-pre-flight.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'docker-compose*.yml'
      - 'config/**'
      - 'database/**'
      - 'monitoring/**'
  workflow_dispatch:

jobs:
  pre-flight-check:
    name: Run Pre-Flight Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          # Make scripts executable
          chmod +x scripts/*.sh

          # Create minimal .env for testing
          cat > .env <<EOF
          ENVIRONMENT=ci
          DEPLOYMENT_ENV=docker
          RADIUS_SECRET=ci_test_secret
          POSTGRES_PASSWORD=ci_test_password
          REDIS_PASSWORD=ci_test_password
          SECRET_KEY=ci_test_secret_key_32_characters
          JWT_SECRET_KEY=ci_test_jwt_secret_32_characters
          EOF

      - name: Run setup script
        run: |
          ./scripts/setup-config-files.sh
        continue-on-error: true

      - name: Run validation script
        run: |
          ./scripts/validate-docker-compose-env.sh

      - name: Run pre-flight checks
        id: preflight
        run: |
          ./scripts/docker-compose-pre-flight.sh | tee preflight-output.txt
        continue-on-error: true

      - name: Check results
        run: |
          if grep -q "Pre-flight check FAILED" preflight-output.txt; then
            echo "::error::Pre-flight check failed with errors"
            exit 1
          elif grep -q "Pre-flight check PASSED with warnings" preflight-output.txt; then
            echo "::warning::Pre-flight check passed but has warnings"
            exit 0
          else
            echo "::notice::Pre-flight check passed successfully"
            exit 0
          fi

      - name: Upload check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-results
          path: preflight-output.txt

  validate-compose:
    name: Validate Docker Compose Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create minimal .env
        run: |
          cat > .env <<EOF
          POSTGRES_PASSWORD=test
          REDIS_PASSWORD=test
          RADIUS_SECRET=test
          SECRET_KEY=test_secret_key_32_characters_min
          JWT_SECRET_KEY=test_jwt_key_32_characters_minimum
          EOF

      - name: Validate docker-compose.base.yml
        run: |
          docker compose -f docker-compose.base.yml config > /dev/null
          echo "✅ docker-compose.base.yml is valid"

      - name: Validate docker-compose.isp.yml
        run: |
          docker compose -f docker-compose.base.yml -f docker-compose.isp.yml config > /dev/null
          echo "✅ docker-compose.isp.yml is valid"

      - name: Check for syntax issues
        run: |
          # Check for common YAML issues
          if grep -r "<<:" docker-compose*.yml | grep -v "# " | grep -v "^#"; then
            echo "::warning::Found YAML anchors/aliases - ensure proper syntax"
          fi

          # Check for unquoted environment variables
          if grep -rE "^\s+[A-Z_]+=\$" docker-compose*.yml; then
            echo "::warning::Found unquoted environment variable references"
          fi

  test-build:
    name: Test Image Build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create test config files
        run: |
          mkdir -p config/radius
          echo "# Test clients" > config/radius/clients.conf.template
          echo "# Test dictionary" > config/radius/dictionary
          echo "# Test SQL" > config/radius/sql.conf
          echo "-- Test schema" > config/radius/postgresql-schema.sql

      - name: Test build FreeRADIUS image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.freeradius
          platforms: linux/amd64
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "### Build Test Summary :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "FreeRADIUS image build test passed successfully." >> $GITHUB_STEP_SUMMARY
