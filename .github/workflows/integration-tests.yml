name: Integration Tests

on:
  push:
    branches: [main, develop, feature/*]
    paths:
      - 'frontend/apps/isp-ops-app/**'
      - 'frontend/apps/platform-admin-app/**'
      - 'frontend/shared/**'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/apps/isp-ops-app/**'
      - 'frontend/apps/platform-admin-app/**'
      - 'frontend/shared/**'
      - '.github/workflows/integration-tests.yml'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '10'

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: dotmac_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: dotmac_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: frontend
        run: pnpm exec playwright install --with-deps chromium

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install Python dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install Python project
        run: poetry install --no-interaction

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://dotmac_user:test_password@localhost:5432/dotmac_test
          REDIS_URL: redis://localhost:6379/0
        run: poetry run alembic upgrade head

      - name: Start backend server
        env:
          DATABASE_URL: postgresql://dotmac_user:test_password@localhost:5432/dotmac_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: test-secret-key-for-ci
          ENVIRONMENT: test
        run: |
          poetry run uvicorn dotmac.platform.routers:app --host 0.0.0.0 --port 8000 &
          echo $! > backend.pid
          # Wait for backend to be ready
          timeout 30 bash -c 'until curl -f http://localhost:8000/health; do sleep 1; done'

      - name: Build ISP Ops frontend
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: pnpm --filter @dotmac/isp-ops-app build

      - name: Start ISP Ops frontend server
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: |
          pnpm --filter @dotmac/isp-ops-app start &
          echo $! > ../frontend.pid
          # Wait for frontend to be ready
          timeout 30 bash -c 'until curl -f http://localhost:3001; do sleep 1; done'

      - name: Run integration tests
        working-directory: frontend
        env:
          ISP_OPS_URL: http://localhost:3001
          API_BASE_URL: http://localhost:8000
        run: pnpm e2e -- --project=chromium

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: frontend/test-results/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
          fi
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) || true
          fi

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: test-results

      - name: Generate test summary
        run: |
          echo "# Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results/results.json ]; then
            echo "## Test Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Parse test results (example - adjust based on actual format)
            PASSED=$(jq '.stats.expected' test-results/results.json || echo "N/A")
            FAILED=$(jq '.stats.unexpected' test-results/results.json || echo "N/A")
            SKIPPED=$(jq '.stats.skipped' test-results/results.json || echo "N/A")

            echo "- ✅ Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- ❌ Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- ⏭️ Skipped: $SKIPPED" >> $GITHUB_STEP_SUMMARY
          else
            echo "Test results not found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Suites" >> $GITHUB_STEP_SUMMARY
          echo "- ISP Ops Auth & Session Flows" >> $GITHUB_STEP_SUMMARY
          echo "- Tenant Provisioning & Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- Billing & Communications Workflows" >> $GITHUB_STEP_SUMMARY

  prevent-flaky-tests:
    name: Prevent Flaky Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: failure()

    steps:
      - name: Check for flaky tests
        run: |
          echo "::warning::Integration tests failed. Please review test logs and ensure tests are deterministic."
          echo "Common causes of flaky tests:"
          echo "- Race conditions"
          echo "- Network timing issues"
          echo "- Database state not properly cleaned up"
          echo "- Hard-coded timeouts"
